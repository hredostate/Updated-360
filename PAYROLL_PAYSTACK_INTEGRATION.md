# Paystack Transfers Integration for Staff Payroll

This document describes the implementation of Paystack Transfers API for automated staff payroll payments.

## Overview

The payroll system now supports automated transfer of salaries to staff bank accounts using Paystack's Transfers API. This eliminates the need for manual bank transfers and provides better tracking and reconciliation.

## Features Implemented

### 1. **Bulk Transfer Support**
- Process multiple staff payments in a single API call
- Reduces processing time and API costs
- Follows Paystack's bulk transfer API specification

### 2. **Transfer Recipient Caching**
- Automatically creates Paystack transfer recipients on first use
- Caches recipient codes in database for faster subsequent transfers
- Validates bank account details via Paystack API

### 3. **Unique Transfer References**
- Generates unique references for each transfer (required by Paystack)
- Format: `payroll-{userid}-{timestamp}-{random}` (16-50 chars, lowercase)
- Enables easy tracking and reconciliation

### 4. **Transfer Status Tracking**
- Tracks individual transfer codes from Paystack
- Monitors transfer status (pending, success, failed, otp)
- Provides verification API to check transfer completion

### 5. **Error Handling**
- Comprehensive error handling at each step
- Failed transfers update payroll run status with error details
- Partial success handling - marks successful transfers even if some fail

## API Endpoints

### Run Payroll (Edge Function)
**Path:** `/supabase/functions/run-payroll/index.ts`

**Request:**
```json
{
  "periodLabel": "March 2024 Salary",
  "reason": "Monthly salary payment",
  "items": [
    {
      "user_id": "uuid",
      "name": "John Doe",
      "gross_amount": 50000,
      "adjustment_ids": [1, 2],
      "bank_code": "058",
      "account_number": "0123456789",
      "narration": "March 2024 salary"
    }
  ]
}
```

**Response:**
```json
{
  "success": true,
  "message": "3 transfers queued.",
  "data": {
    "payroll_run_id": 123,
    "total_amount": 150000,
    "transfers_count": 3,
    "paystack_response": [...]
  }
}
```

### Verify Transfer (Edge Function)
**Path:** `/supabase/functions/verify-transfer/index.ts`

**Request:**
```json
{
  "reference": "payroll-abc123-1234567890-xyz789"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Transfer status verified",
  "data": {
    "reference": "payroll-abc123-1234567890-xyz789",
    "status": "success",
    "amount": 5000000,
    "recipient": "RCP_xxx",
    "created_at": "2024-03-01T10:00:00Z",
    "transferred_at": "2024-03-01T10:05:00Z"
  }
}
```

## Database Schema

### New Columns in `payroll_items` Table

```sql
ALTER TABLE public.payroll_items 
ADD COLUMN IF NOT EXISTS transfer_reference TEXT;

ALTER TABLE public.payroll_items 
ADD COLUMN IF NOT EXISTS transfer_code TEXT;
```

- **transfer_reference**: Unique identifier for tracking (generated by system)
- **transfer_code**: Paystack's transfer code (e.g., `TRF_xxxxx`)
- **transfer_status**: Current status (pending, success, failed, otp)

### Existing Tables Used

- **payroll_runs**: Main payroll run record
- **payroll_items**: Individual staff payment records
- **payroll_adjustments**: Salary adjustments (bonuses, deductions)
- **paystack_recipients**: Cached Paystack recipient codes

## Paystack API Integration

### 1. Create Transfer Recipient
```
POST https://api.paystack.co/transferrecipient
```
Creates a recipient for bank transfers. Response includes `recipient_code` which is cached.

### 2. Initiate Bulk Transfer
```
POST https://api.paystack.co/transfer/bulk
```
Initiates multiple transfers at once. Each transfer includes:
- `amount`: Amount in kobo (multiply NGN by 100)
- `recipient`: Recipient code from step 1
- `reference`: Unique reference (16-50 chars)
- `reason`: Description of transfer

### 3. Verify Transfer
```
GET https://api.paystack.co/transfer/verify/{reference}
```
Checks the status of a transfer using its reference.

## Configuration

### Environment Variables (Supabase Edge Functions)
- `PAYSTACK_SECRET_KEY`: Your Paystack secret key
- `SUPABASE_URL`: Supabase project URL
- `SUPABASE_ANON_KEY`: Supabase anonymous key
- `SUPABASE_SERVICE_ROLE_KEY`: Supabase service role key

### Required Permissions
- Users must have `manage-payroll` permission to run payroll
- Edge functions run with elevated privileges using service role

## Usage Flow

1. **Prepare Payroll Data**
   - Admin reviews staff list with base pay and commissions
   - Adds any adjustments (bonuses or deductions)
   - Verifies bank account details are complete

2. **Run Payroll**
   - Click "Process Payroll" button
   - System calculates net amounts including adjustments
   - Creates/retrieves Paystack recipients
   - Initiates bulk transfer via Paystack API
   - Updates database with transfer details

3. **Monitor Status**
   - View payroll run status in dashboard
   - Check individual transfer codes
   - Use verify endpoint to confirm completion

4. **Handle Failures**
   - Review failed transfers in payroll history
   - Check error messages in run meta data
   - Retry failed transfers manually if needed

## Testing

### Test Mode
Paystack provides test API keys for development:
- Use test secret key starting with `sk_test_`
- Transfers won't actually move money
- Use Paystack test bank accounts

### Live Mode
For production:
- Use live secret key starting with `sk_live_`
- Ensure sufficient balance in Paystack account
- Monitor transfers in Paystack dashboard
- Enable transfer OTP if required

## Security Considerations

1. **API Key Security**
   - Store Paystack secret key in environment variables
   - Never expose secret keys in frontend code
   - Rotate keys periodically

2. **Transfer Validation**
   - Verify bank account details before transfer
   - Implement approval workflows for large amounts
   - Log all transfer attempts for audit trail

3. **Error Handling**
   - Never expose sensitive error details to frontend
   - Log errors securely for debugging
   - Implement retry logic with exponential backoff

## Troubleshooting

### Common Issues

**Issue:** "Paystack secret key is not configured"
- **Solution:** Set `PAYSTACK_SECRET_KEY` in Supabase edge function secrets

**Issue:** "Failed to create Paystack recipient"
- **Solution:** Verify bank code and account number are correct

**Issue:** "Bulk transfer initiation failed"
- **Solution:** Check Paystack account balance and transfer limits

**Issue:** Transfer status shows "otp"
- **Solution:** Complete OTP verification in Paystack dashboard

## Migration Guide

To apply the database changes:

```sql
-- Run this in your Supabase SQL editor
\i supabase/migrations/add_transfer_tracking_columns.sql
```

Or the migration will be automatically applied on next deployment.

## Support

For issues or questions:
- Check Paystack API documentation: https://paystack.com/docs/transfers/
- Review Supabase edge function logs
- Contact system administrator

## Future Enhancements

Potential improvements:
1. Add webhook handler for transfer status updates
2. Implement OTP flow for high-value transfers
3. Add transfer scheduling for future dates
4. Generate reconciliation reports
5. Support multiple currencies (GHS, etc.)
